{"componentChunkName":"component---src-templates-blog-post-js","path":"/190824/","result":{"data":{"site":{"siteMetadata":{"title":"SpXn-Blog","author":"_spxn"}},"markdownRemark":{"id":"ff2e7541-84c3-50c1-923e-1d94aa12b34d","excerpt":"2016年にLinuxのカーネルにおいて発見された脆弱性であるDirtyCOW(CVE-2016-519…","html":"<p>　2016年にLinuxのカーネルにおいて発見された脆弱性であるDirtyCOW(CVE-2016-5195)はレースコンディションと呼ばれるプロセスやスレッドによって生じるバグを悪用した攻撃になります。<br>\nレースコンディション(特にファイルレースコンディション)は同一のリソースに複数のプロセスやスレッドがアクセスした際に意図しない動作を引き起こしてしまう現象です。  </p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 390px;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/ecaa8feb59ed9594f16178e6eb304f01/14f69/dirtycow.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 52.56410256410257%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABgUlEQVQoz5VRW0sCURD2N0Y/oELoKajoyYceMpIgSwk0kpQUTHsy8lIrXlLD1NT1tupmlmgXb6m76La6anNcpQhCG+bhzJzzzXzfdwTDUQwmMfxPCHjoeES/T9Uq1UKeoSk4zwTmel26XqXrtRh2aZNLfHp1xueCJmICIyaM+BLlpIPA5UfSf659ySTxa3MhQ5BxvEgk+NdTNgNPwo3xRSlLRJyYS3v8mstC2W42YE+f67FMu89xbKfN0K1OqwGkeuwnArNMx3K4a9wWXcgk7jONfnNdsTRfTOJwp1lZOF0VWuUSq2wn4bCFTAbl4px2TajbWC7nHxAYuFmVBzqxyKY7sRt0+K0nGbx7ikXgzq7cN0vFIZMx5bwqpROk/8Ys3QKBDpUcWIw0DwbpoN+0J8Y0R5hakUvEyGi4QzV/av5LPDKMDAdcWlXa72lV3sn7QMrrYigK+qATFI/sHTsMnZEL3De4UX5Lep28Sc/xKI5Z6I/6TG6jf+52IdHUaTx/xRfdvlXNdV6bnAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"dirtycow\" title=\"dirtycow\" src=\"/static/ecaa8feb59ed9594f16178e6eb304f01/14f69/dirtycow.png\" srcset=\"/static/ecaa8feb59ed9594f16178e6eb304f01/cf440/dirtycow.png 148w,\n/static/ecaa8feb59ed9594f16178e6eb304f01/d2d38/dirtycow.png 295w,\n/static/ecaa8feb59ed9594f16178e6eb304f01/14f69/dirtycow.png 390w\" sizes=\"(max-width: 390px) 100vw, 390px\" loading=\"lazy\">\n  </a>\n    </span>\n<h2>「レースコンディション」</h2>\n<p>例として同一の変数xを二つのプロセスが参照し、片方のプロセスAが変数の値を+3インクリメントし、もう片方のプロセスBが変数の値を+2インクリメントする場合を想定した場合、\n正常に順番通り実行されれば結果として変数の値が+5インクリメントされますが、プロセスAとプロセスBが同時に読み込み時間差でプロセスBが書き込む、といった状況が生じた時に結果として変数の値が+2インクリメントされた\n状態で結果が返ります。こういった具合で本来想定していた結果と異なる状態になってしまうことをレースコンディションといいます。 </p>\n<h2>「COW機構とDirtyCOW」</h2>\n<p>DirtyCOWはLinuxカーネル上のCOW機構(Copy-on-Write)におけるセキュリティホールです。\nCOW機構はデータをプロセスごとにコピーしてメモリ上に展開する際に、変更要求が生じるまではコピーせずに同一のリソースを参照させるというコンピュータにおける最適化戦略です。<br>\nCOWによりメモリの負荷を軽減, 無駄なリソースのコピーを防ぐことが可能です。<br>\nしかし、COW機構において同一のリソースを参照させるという点に脆弱性につながるバグがあったというわけです。以下に、ソースコードから読み取った権限昇格までの流れを示します。完全に意訳して書いているのでより完全に理解したければソースコードを読みましょう。そこまで、難しいことは書いてないです。</p>\n<h2>DirtyCOWによって権限昇格するまでの流れ(<a href=\"https://github.com/dirtycow/dirtycow.github.io/blob/master/dirtyc0w.c\">dirtyc0w.c</a>より):</h2>\n<ol>\n<li>同一リソース(例では、ファイル)に対して二つのスレッドを同時に100,000,000回実行する<br>\n<code class=\"language-text\">一つ目は展開されたメモリ上のファイルに対して領域を解放するシグナル(MADV_DONTNEED)を送信するスレッド</code><br>\n<code class=\"language-text\">二つ目はメモリ上のファイルが存在する領域にプロセスの擬似ファイル*を直接指定することでアクセスし、書き込みを要求するスレッド</code><br>\n<small>*一つ目のスレッドが参照しているメモリの場所</small></li>\n<li>レースコンデイションが発生した場合にメモリ上のファイルへの書き込みが完了する<br>\n<code class=\"language-text\">管理者権限が必要なファイルに対しても権限をチェックする前に書き込みが行われるため、権限のバイパス、権限昇格が可能になる</code>  </li>\n</ol>\n<p>本来であれば、ソースコードの61行目である<br>\n<code class=\"language-text\">int f=open(&quot;/proc/self/mem&quot;,O_RDWR);</code><br>\nのところで、ファイルが読み取り専用なので読み書き(O_RDWRフラグ)じゃ開けないよとエラーが返るはずなのですが、レースコンディションのせいで開けてしまった…権限バイパスして書き込めちゃった…っていうのがDirtyCOWです。  </p>\n<p>試してみます。</p>\n<h2>DirtyCOWによる権限昇格の脆弱性検証:</h2>\n<ol>\n<li>DirtyCOW(CVE-2016-5195)の脆弱性を持つLinuxカーネルを仮想環境に構築する<br>\n<small>*検証環境としてUbuntu 14.04で行う</small>  </li>\n<li>Ubuntu14.04を手順に沿ってセットアップする<br>\n<small>rootではない検証用のユーザを作成したりとか…</small></li>\n<li>GitHubより<a href=\"https://github.com/dirtycow/dirtycow.github.io/blob/master/dirtyc0w.c\">dirtyc0w.c</a>をダウンロードする</li>\n<li>管理者読み取り専用ファイルを作成し、管理者権限でないことを確認(既に管理者権限であれば検証の意味…)<br>\n<code class=\"language-text\">$sudo echo &quot;this is read only.you can&#39;t write anything&quot; &gt; foo</code><br>\n<code class=\"language-text\">$sudo chmod 0404 foo</code><br>\n<small>普通に読み取り専用ファイルをvimで編集しようとすると[readonly]と表示が出て書き込みができない</small></li>\n<li>ダウンロードした<a href=\"https://github.com/dirtycow/dirtycow.github.io/blob/master/dirtyc0w.c\">dirtyc0w.c</a>をコンパイル&#x26;実行<br>\n<code class=\"language-text\">$gcc -pthread dirtyc0w.c -o dirtyc0w</code><br>\n<code class=\"language-text\">$./dirtyc0w foo hogehoge</code>  </li>\n<li>手順が正しければ書き込みが成功する。<br>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/0f32dcde6f2e286bfa40c579121d0dc5/7b680/poc-result.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.57534246575342%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABk0lEQVQoz31RaW+CQBDlS+sRtTapV6utwQOwCLgcIiCggoJ3rKTt//8jfVtNE41p8rLZgZ15xzAfWvxlbtfidCeFR2215H2vbujFd7UgaA89kudJgdcKPTUv4AtKesnTXyiZRWecaKtp03SftVnTmrwOnSoZ11S7QoxHEbDKilMjdmXgVAejkmyVB7h7dR1vmJ0cbMTZXp6HrLXtB+BftMdLzg9YO2zZeK1ku/1US0q1/06Ke3oyBzVK9HWir6Kuu1cWO3m+6Lghay/5ybztgBZA/wlypiNnKU4lmEPQ7qQ5XqPtV7kJQr9hoI3kBZLjKGe6TTsvwSTDFTwfSISoEmPzbe8RGyxBSMx5OGfNEbJxauogx12NYLZSuBEDNMMtfLovuvkk2VWaEMinb6ZW7CmZLnKmgq+YIRLyMBuFeMeK9yzGn1LBHV9ObLdlu3UdbFgM5AWshR2eHaZvN1w0LwUfq4JhKIw4Dwn7dWPSGFolBUsmOf6fEcxRiz+HWxqY4B9ITHfGeTHn0p11Xfg/b+gWfgCVBXDkFRGKXAAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"poc result\" title=\"poc result\" src=\"/static/0f32dcde6f2e286bfa40c579121d0dc5/b9e4f/poc-result.png\" srcset=\"/static/0f32dcde6f2e286bfa40c579121d0dc5/cf440/poc-result.png 148w,\n/static/0f32dcde6f2e286bfa40c579121d0dc5/d2d38/poc-result.png 295w,\n/static/0f32dcde6f2e286bfa40c579121d0dc5/b9e4f/poc-result.png 590w,\n/static/0f32dcde6f2e286bfa40c579121d0dc5/7b680/poc-result.png 730w\" sizes=\"(max-width: 590px) 100vw, 590px\" loading=\"lazy\">\n  </a>\n    </span></li>\n</ol>\n<p><small>(なんか思ってたのと違うけど面白いのでこれを採用しました笑)</small></p>\n<p>　この脆弱性を悪用してユーザ権限を管理しているファイル(<code class=\"language-text\">/etc/passwd</code> <code class=\"language-text\">/etc/group</code> <code class=\"language-text\">/etc/shadow</code>など)を書き換えれば半永久的な権限を取得できたりする<a href=\"#2\"><small>*2</small></a>ので、脆弱性による被害は大きくなる。<br>\nリモートからのコード実行やソーシャルエンジニアリングによる侵入が無ければそもそも使えないものの、Linuxのカーネルレベルで存在するところはかなり厄介だ。<br>\nまた、DirtyCOWの<a href=\"https://github.com/dirtycow/dirtycow.github.io/wiki/PoCs\">PoC</a>が多く用意され、容易に攻撃が行えることも被害が大きくなる原因となっている。\nかなり昔の脆弱性なので最新のLinuxディストリビューションを使用していれば被害にあうことはまずない。心がけたい。\n今後の反省点としてはPoCを用いた検証画面にオシャレなオチを取り入れて記事に勢いをつけたいですね笑。かっこいい検証ようペイロードを考えないと。おわり。</p>\n<p><small id=\"2\">*2</small> <a href=\"https://gist.github.com/rverton/e9d4ff65d703a9084e85fa9df083c679\">cowroot.c</a>はDirtyCOWを利用したroot権限への昇格を可能にしている。</p>","frontmatter":{"title":"Linuxカーネルにおける権限昇格(DirtyCOW:CVE-2016-5195)の脆弱性検証","date":"August 24, 2019"}}},"pageContext":{"slug":"/190824/","previous":{"fields":{"slug":"/190801/"},"frontmatter":{"title":"WhonixによるTorゲートウェイの構築及び仮想マシンにおけるIPアドレス匿名化の検証"}},"next":{"fields":{"slug":"/200310/"},"frontmatter":{"title":"Torによる通信経路匿名化の仕組みと応用"}}}}}