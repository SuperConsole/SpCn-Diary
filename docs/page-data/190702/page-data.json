{"componentChunkName":"component---src-templates-blog-post-js","path":"/190702/","webpackCompilationHash":"e489af732c600e42b42c","result":{"data":{"site":{"siteMetadata":{"title":"SpXn-Blog","author":"_spxn"}},"markdownRemark":{"id":"2513d668-702a-5d95-8dde-b0aefe5c7669","excerpt":"某セキュリティ会社が発行している「JSOC INSIGHT」のvol.22にて「Apache Struts 2におけるリモートコード実行の脆弱性」が取り上げられていたので持ち前の情報収集力を生かしてこの脆弱性を再現・検証したのでそれをまとめます。\nまず、この脆弱性はURLに数値計算式またはOSコマンドを実行するOGNL…","html":"<p>　某セキュリティ会社が発行している「JSOC INSIGHT」のvol.22にて「Apache Struts 2におけるリモートコード実行の脆弱性」が取り上げられていたので持ち前の情報収集力を生かしてこの脆弱性を再現・検証したのでそれをまとめます。\nまず、この脆弱性はURLに数値計算式またはOSコマンドを実行するOGNL文をインジェクションすることで悪用されます。Apache Struts2の設定ファイルである「struts.xml」において、<br>\n・「alwaysSelectFullNamespace」をtrueにしている<br>\n・「actionタグ」または「urlタグ」が含まれている  </p>\n<p>これらの条件をいずれも満たす場合に影響を受けます。今回の検証ではこの脆弱性を持つApache Struts 2.3.12内蔵のDockerコンテナ(piesecurity/apache-struts2-cve-2017-5638、以下Dockerコンテナ)を用意し、struts.xmlに設定を追加したのちにPoC(python)を実行し、サーバ内の機密情報(ここでは/etc/passwdファイル)を読み取るまでの流れを示す。  </p>\n<p>方法(<a href=\"https://github.com/hook-s3c/CVE-2018-11776-Python-PoC\">hook-s3c氏のPoC</a>より):  </p>\n<ol>\n<li>Dockerコンテナ(piesecurity/apache-struts2-cve-2017-5638)をdockerhubよりプル<br>\n<code class=\"language-text\">$docker pull piesecurity/apache-struts2-cve-2017-5638</code>  </li>\n<li>コンテナをポート32771番に指定しデタッチモードにて起動//被害側<br>\n<code class=\"language-text\">$docker run -d -p 32771:8080 piesecurity/apache-struts2-cve-2017-5638</code>  </li>\n<li>エディタ(vim)をインストールした後設定ファイルを編集する(内容はリンク先参照,設定ファイルの様式にしたがって追加すること)<br>\n<code class=\"language-text\">$vim /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/struts.xml</code>  </li>\n<li>Apache Struts2(Dockerコンテナ)を再起動<br>\n<code class=\"language-text\">$exit</code><br>\n<code class=\"language-text\">$docker restart [コンテナID]</code><br>\n<code class=\"language-text\">$docker exec -it [コンテナID] bash</code>  </li>\n<li>攻撃側PCからDockerコンテナの32771番ポートにアクセス　　</li>\n</ol>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 435px;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/38f291fef97cd8a785923cce4bae2305/48ba6/CVE-2018-11776-poc-struts2.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 33.793103448275865%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABGElEQVQoz4VR20rEMBDNV/nkg9/iLwniL/gb6oMo9aGyuoJWtNc0bZLS61q7x8mUXcoiOnCYOXNmQnIi4jhCmqbICHEco7IVcikhZYamrqHyHHkuqZdBlyW6tuVcFIq1HVdKcS02mw2GYdhjHEcWWoLjXdfted/3cPN933Hf9ZgvapEkKWxVoWkaGGNgrcVhbJfY4s8QD56H1eoJ6/ULfN9HEATzIf9tLmaWs6Kk9xujyZOCb1iWmvwjz8gfp71HKd6iDK9hQqCacsYeS95x/kuaVWquhSNOcAckSTILGX2A1vwZp5cejs6ucHJxg+Pza86PQYiOLHIxTRPfcAexJIdwrj3LGrcfGvehwd2ngRdZDF/frP1myg8SDxPFb03+rQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"CVE 2018 11776 poc struts2\" title=\"CVE 2018 11776 poc struts2\" src=\"/static/38f291fef97cd8a785923cce4bae2305/48ba6/CVE-2018-11776-poc-struts2.png\" srcset=\"/static/38f291fef97cd8a785923cce4bae2305/cf440/CVE-2018-11776-poc-struts2.png 148w,\n/static/38f291fef97cd8a785923cce4bae2305/d2d38/CVE-2018-11776-poc-struts2.png 295w,\n/static/38f291fef97cd8a785923cce4bae2305/48ba6/CVE-2018-11776-poc-struts2.png 435w\" sizes=\"(max-width: 435px) 100vw, 435px\" loading=\"lazy\">\n  </a>\n    </span>  \n  \n6. URL&#x306E;&#x6307;&#x5B9A;&#x90E8;(JSOC INSIGHT&#x3092;&#x53C2;&#x7167;)&#x306B;OGNL&#x6587;&#x3092;&#x633F;&#x5165;&#x3059;&#x308B;([atucom.net](http://blog.atucom.net/2018/08/apache-struts-2-vulnerability-exploit.html)&#x3088;&#x308A;OS&#x30B3;&#x30DE;&#x30F3;&#x30C9;&#x304B;&#x3089;OGNL&#x6587;&#x751F;&#x6210;&#x3059;&#x308B;PoC&#x304C;&#x516C;&#x958B;&#x3055;&#x308C;&#x3066;&#x3044;&#x308B;&#x306E;&#x3067;&#x3053;&#x308C;&#x3092;&#x5229;&#x7528;&#x3057;&#x305F;&#x3002;&#x30A6;&#x30A4;&#x30EB;&#x30B9;&#x306B;&#x611F;&#x67D3;&#x3059;&#x308B;&#x6050;&#x308C;&#x304C;&#x3042;&#x308B;&#x306E;&#x3067;&#x5B9F;&#x884C;&#x306F;&#x81EA;&#x5DF1;&#x8CAC;&#x4EFB;)  \n`$python ./a.py`  \n  \n7. OS&#x30A4;&#x30F3;&#x30B8;&#x30A7;&#x30AF;&#x30B7;&#x30E7;&#x30F3;&#x304C;&#x884C;&#x308F;&#x308C;&#x3001;&#x653B;&#x6483;&#x5074;&#x306B;&#x3066;&#x88AB;&#x5BB3;&#x5074;&#x5185;&#x306B;&#x3042;&#x308B;&#x6A5F;&#x5BC6;&#x60C5;&#x5831;/etc/passwd&#x30D5;&#x30A1;&#x30A4;&#x30EB;)&#x306E;&#x8AAD;&#x307F;&#x53D6;&#x308A;&#x306B;&#x6210;&#x529F;&#x3057;&#x3066;&#x3044;&#x308B;&#x3053;&#x3068;&#x3092;&#x78BA;&#x8A8D;&#x3067;&#x304D;&#x308B;&#x3002;  \n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/bd7d24b1b615ea4dcc59f0d2cc42ac42/52699/CVE-2018-11776-poc-result.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 47.02194357366772%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAAAmklEQVQoz6WRyxKCMAxFEwcVpdNSGKaIDD7+/x/jvSMLlkoWp+mmp7mJxJztkqKFGK2rT7ac1YajWitiNWjAAcivTDgyGEEBs6h1qPqPZEuvagGMoIAZNB7hEwJ2eEedwBv0KlbtFRY8ZkTKFsAPrntlZIAwcH6ovD8gjJ7IFCX5ygijs+PKM8OykTH2i4vyRE7rUm7rUlpH5A9WWLjpsZ70SQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"CVE 2018 11776 poc result\" title=\"CVE 2018 11776 poc result\" src=\"/static/bd7d24b1b615ea4dcc59f0d2cc42ac42/b9e4f/CVE-2018-11776-poc-result.png\" srcset=\"/static/bd7d24b1b615ea4dcc59f0d2cc42ac42/cf440/CVE-2018-11776-poc-result.png 148w,\n/static/bd7d24b1b615ea4dcc59f0d2cc42ac42/d2d38/CVE-2018-11776-poc-result.png 295w,\n/static/bd7d24b1b615ea4dcc59f0d2cc42ac42/b9e4f/CVE-2018-11776-poc-result.png 590w,\n/static/bd7d24b1b615ea4dcc59f0d2cc42ac42/52699/CVE-2018-11776-poc-result.png 638w\" sizes=\"(max-width: 590px) 100vw, 590px\" loading=\"lazy\">\n  </a>\n    </span>  \n  \n&#x4EE5;&#x4E0A;&#x3002;&#x6570;&#x5024;&#x8A08;&#x7B97;&#x5F0F;&#x3092;&#x633F;&#x5165;&#x3059;&#x308B;PoC&#x306F;&#x30B6;&#x30C3;&#x3068;&#x8ABF;&#x3079;&#x305F;&#x3060;&#x3051;&#x3067;&#x3082;&#x304B;&#x306A;&#x308A;&#x306E;&#x30B5;&#x30A4;&#x30C8;&#x306B;&#x8F09;&#x3063;&#x3066;&#x3044;&#x305F;&#x304C;&#x5B9F;&#x969B;&#x306B;&#x60AA;&#x7528;&#x53EF;&#x80FD;&#x306A;OGNL&#x6587;&#x3092;&#x633F;&#x5165;&#x3059;&#x308B;&#x30B3;&#x30FC;&#x30C9;&#x3092;&#x516C;&#x958B;&#x3059;&#x308B;JSOC INSIGHT&#x306F;&#x4E00;&#x5473;&#x9055;&#x3046;&#x306A;&#x3068;&#x5B9F;&#x611F;&#x3057;&#x307E;&#x3057;&#x305F;(&#x8AB0;&#x76EE;&#x7DDA;)&#x3002;&#x8A71;&#x306F;&#x5909;&#x308F;&#x308B;&#x306E;&#x3067;&#x3059;&#x304C;&#x3001;&#x4EE5;&#x524D;[PoC&#x306B;&#x898B;&#x305B;&#x304B;&#x3051;&#x3066;&#x672C;&#x5F53;&#x306B;&#x30EA;&#x30E2;&#x30FC;&#x30C8;&#x3067;&#x5B9F;&#x884C;&#x3055;&#x308C;&#x308B;&#x3084;&#x3064;](https://web.archive.org/web/20190702145836/https:/twitter.com/x64koichi/status/1141635520419602432/photo/1)&#x304C;&#x5DF7;&#x3067;&#x8A71;&#x984C;&#x306B;&#x306A;&#x308A;&#x307E;&#x3057;&#x305F;&#x306D;&#x3002;&#x3053;&#x3046;&#x3044;&#x3046;&#x3053;&#x3068;&#x304C;&#x5C11;&#x306A;&#x304B;&#x3089;&#x305A;&#x3042;&#x308B;&#x306E;&#x3067;PoC&#x3092;&#x4F7F;&#x3063;&#x3066;&#x691C;&#x8A3C;&#x3059;&#x308B;&#x306B;&#x306F;&#x30BD;&#x30FC;&#x30B9;&#x30B3;&#x30FC;&#x30C9;&#x306B;&#x76EE;&#x3092;&#x901A;&#x3059;&#x3053;&#x3068;&#x304C;&#x5927;&#x524D;&#x63D0;&#x3067;&#x3059;&#x3002;  \n&#x4ECA;&#x56DE;&#x306E;&#x74B0;&#x5883;&#x3067;&#x306F;truts.xml&#x306E;&#x300C;alwaysSelectFullNamespace&#x300D;&#x3092;&#x7121;&#x52B9;&#x306B;&#x3057;&#x305F;&#x3053;&#x3068;&#x3067;ONGL&#x6587;&#x306B;&#x3088;&#x308B;OS&#x30A4;&#x30F3;&#x30B8;&#x30A7;&#x30AF;&#x30B7;&#x30E7;&#x30F3;&#x304C;&#x52B9;&#x304B;&#x306A;&#x304F;&#x306A;&#x3063;&#x305F;&#x3053;&#x3068;&#x3001;&#x30D0;&#x30FC;&#x30B8;&#x30E7;&#x30F3;&#x30A2;&#x30C3;&#x30D7;&#x306B;&#x3088;&#x3063;&#x3066;&#x8106;&#x5F31;&#x6027;&#x304C;&#x89E3;&#x6D88;&#x3055;&#x308C;&#x305F;&#x3053;&#x3068;&#x3092;&#x78BA;&#x8A8D;&#x3057;&#x307E;&#x3057;&#x305F;&#x3002;&#x30BB;&#x30AD;&#x30E5;&#x30EA;&#x30C6;&#x30A3;&#x3001;&#x65E5;&#x9803;&#x304B;&#x3089;&#x610F;&#x8B58;&#x3057;&#x3066;&#x3044;&#x304D;&#x307E;&#x3057;&#x3087;&#x3046;...&#x3002;&#x304A;&#x308F;&#x308A;&#x3002;","frontmatter":{"title":"Apache Struts 2におけるリモートコード実行(CVE-2018-11776)の脆弱性検証","date":"July 02, 2019"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/190702/","previous":{"fields":{"slug":"/190615/"},"frontmatter":{"title":"VPNGate with Proxyを用いた通信の秘匿"}},"next":{"fields":{"slug":"/190715/"},"frontmatter":{"title":"OWASP ZAPを用いたWebサイトの脆弱性診断"}}}}}