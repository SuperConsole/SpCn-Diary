{"componentChunkName":"component---src-templates-blog-post-js","path":"/190702/","result":{"data":{"site":{"siteMetadata":{"title":"SpXn-Blog","author":"_spxn"}},"markdownRemark":{"id":"2513d668-702a-5d95-8dde-b0aefe5c7669","excerpt":"某セキュリティ会社が発行している「JSOC INSIGHT」のvol.22にて「Apache Struts 2におけるリモートコード実行の脆弱性」が取り上げられていたので持ち前の情報収集力を生かしてこの脆弱性を再現・検証したのでそれをまとめます。\nまず、この脆弱性はURLに数値計算式またはOSコマンドを実行するOGNL…","html":"<p>　某セキュリティ会社が発行している「JSOC INSIGHT」のvol.22にて「Apache Struts 2におけるリモートコード実行の脆弱性」が取り上げられていたので持ち前の情報収集力を生かしてこの脆弱性を再現・検証したのでそれをまとめます。\nまず、この脆弱性はURLに数値計算式またはOSコマンドを実行するOGNL文をインジェクションすることで悪用されます。Apache Struts2の設定ファイルである「struts.xml」において、<br>\n・「alwaysSelectFullNamespace」をtrueにしている<br>\n・「actionタグ」または「urlタグ」が含まれている  </p>\n<p>これらの条件をいずれも満たす場合に影響を受けます。今回の検証ではこの脆弱性を持つApache Struts 2.3.12内蔵のDockerコンテナ(piesecurity/apache-struts2-cve-2017-5638、以下Dockerコンテナ)を用意し、struts.xmlに設定を追加したのちにPoC(python)を実行し、サーバ内の機密情報(ここでは/etc/passwdファイル)を読み取るまでの流れを示す。  </p>\n<p>方法(<a href=\"https://github.com/hook-s3c/CVE-2018-11776-Python-PoC\">hook-s3c氏のPoC</a>より):  </p>\n<ol>\n<li>Dockerコンテナ(piesecurity/apache-struts2-cve-2017-5638)をdockerhubよりプル<br>\n<code class=\"language-text\">$docker pull piesecurity/apache-struts2-cve-2017-5638</code>  </li>\n<li>コンテナをポート32771番に指定しデタッチモードにて起動//被害側<br>\n<code class=\"language-text\">$docker run -d -p 32771:8080 piesecurity/apache-struts2-cve-2017-5638</code>  </li>\n<li>エディタ(vim)をインストールした後設定ファイルを編集する(内容はリンク先参照,設定ファイルの様式にしたがって追加すること)<br>\n<code class=\"language-text\">$vim /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/struts.xml</code>  </li>\n<li>Apache Struts2(Dockerコンテナ)を再起動<br>\n<code class=\"language-text\">$exit</code><br>\n<code class=\"language-text\">$docker restart [コンテナID]</code><br>\n<code class=\"language-text\">$docker exec -it [コンテナID] bash</code>  </li>\n<li>攻撃側PCからDockerコンテナの32771番ポートにアクセス　　</li>\n</ol>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 435px;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/38f291fef97cd8a785923cce4bae2305/48ba6/CVE-2018-11776-poc-struts2.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 33.793103448275865%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABGElEQVQoz4VR20rEMBDNV/nkg9/iLwniL/gb6oMo9aGyuoJWtNc0bZLS61q7x8mUXcoiOnCYOXNmQnIi4jhCmqbICHEco7IVcikhZYamrqHyHHkuqZdBlyW6tuVcFIq1HVdKcS02mw2GYdhjHEcWWoLjXdfted/3cPN933Hf9ZgvapEkKWxVoWkaGGNgrcVhbJfY4s8QD56H1eoJ6/ULfN9HEATzIf9tLmaWs6Kk9xujyZOCb1iWmvwjz8gfp71HKd6iDK9hQqCacsYeS95x/kuaVWquhSNOcAckSTILGX2A1vwZp5cejs6ucHJxg+Pza86PQYiOLHIxTRPfcAexJIdwrj3LGrcfGvehwd2ngRdZDF/frP1myg8SDxPFb03+rQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"CVE 2018 11776 poc struts2\" title=\"CVE 2018 11776 poc struts2\" src=\"/static/38f291fef97cd8a785923cce4bae2305/48ba6/CVE-2018-11776-poc-struts2.png\" srcset=\"/static/38f291fef97cd8a785923cce4bae2305/cf440/CVE-2018-11776-poc-struts2.png 148w,\n/static/38f291fef97cd8a785923cce4bae2305/d2d38/CVE-2018-11776-poc-struts2.png 295w,\n/static/38f291fef97cd8a785923cce4bae2305/48ba6/CVE-2018-11776-poc-struts2.png 435w\" sizes=\"(max-width: 435px) 100vw, 435px\" loading=\"lazy\">\n  </a>\n    </span>\n  \n<ol start=\"6\">\n<li>URLの指定部(JSOC INSIGHTを参照)にOGNL文を挿入する( <a href=\"http://blog.atucom.net/2018/08/apache-struts-2-vulnerability-exploit.html\">atucom.net</a> )よりOSコマンドからOGNL文生成するPoCが公開されているのでこれを利用した。ウイルスに感染する恐れがあるので実行は自己責任)\n<code class=\"language-text\">$python ./a.py</code>  </li>\n<li>OSインジェクションが行われ、攻撃側にて被害側内にある機密情報/etc/passwdファイル)の読み取りに成功していることを確認できる。  </li>\n</ol>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/bd7d24b1b615ea4dcc59f0d2cc42ac42/52699/CVE-2018-11776-poc-result.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 47.02194357366772%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAAAmklEQVQoz6WRyxKCMAxFEwcVpdNSGKaIDD7+/x/jvSMLlkoWp+mmp7mJxJztkqKFGK2rT7ac1YajWitiNWjAAcivTDgyGEEBs6h1qPqPZEuvagGMoIAZNB7hEwJ2eEedwBv0KlbtFRY8ZkTKFsAPrntlZIAwcH6ovD8gjJ7IFCX5ygijs+PKM8OykTH2i4vyRE7rUm7rUlpH5A9WWLjpsZ70SQAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"CVE 2018 11776 poc result\" title=\"CVE 2018 11776 poc result\" src=\"/static/bd7d24b1b615ea4dcc59f0d2cc42ac42/b9e4f/CVE-2018-11776-poc-result.png\" srcset=\"/static/bd7d24b1b615ea4dcc59f0d2cc42ac42/cf440/CVE-2018-11776-poc-result.png 148w,\n/static/bd7d24b1b615ea4dcc59f0d2cc42ac42/d2d38/CVE-2018-11776-poc-result.png 295w,\n/static/bd7d24b1b615ea4dcc59f0d2cc42ac42/b9e4f/CVE-2018-11776-poc-result.png 590w,\n/static/bd7d24b1b615ea4dcc59f0d2cc42ac42/52699/CVE-2018-11776-poc-result.png 638w\" sizes=\"(max-width: 590px) 100vw, 590px\" loading=\"lazy\">\n  </a>\n    </span>\n<p>以上。数値計算式を挿入するPoCはザッと調べただけでもかなりのサイトに載っていたが実際に悪用可能なOGNL文を挿入するコードを公開するJSOC INSIGHTは一味違うなと実感しました(誰目線)。話は変わるのですが、以前<a href=\"https://web.archive.org/web/20190702145836/https:/twitter.com/x64koichi/status/1141635520419602432/photo/1\">PoCに見せかけて本当にリモートで実行されるやつ</a>が巷で話題になりましたね。こういうことが少なからずあるのでPoCを使って検証するにはソースコードに目を通すことが大前提です。<br>\n今回の環境ではtruts.xmlの「alwaysSelectFullNamespace」を無効にしたことでONGL文によるOSインジェクションが効かなくなったこと、バージョンアップによって脆弱性が解消されたことを確認しました。セキュリティ、日頃から意識していきましょう…。おわり。</p>","frontmatter":{"title":"Apache Struts 2におけるリモートコード実行(CVE-2018-11776)の脆弱性検証","date":"July 02, 2019"}}},"pageContext":{"slug":"/190702/","previous":{"fields":{"slug":"/190615/"},"frontmatter":{"title":"VPNGate with Proxyを用いた通信の秘匿"}},"next":{"fields":{"slug":"/190715/"},"frontmatter":{"title":"OWASP ZAPを用いたWebサイトの脆弱性診断"}}}}}