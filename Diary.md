# [SpCn-Diary](https://github.com/SuperConsole/SpCn-Diary/tree/master)  
2019年の目標:「探求し続ける」
## OWASP ZAPを用いたWebサイトの脆弱性診断(07/15/19)
　久しぶりの投稿。今回はOWASP ZAPを用いてWebサイトの脆弱性診断を行ったのでその流れと結果を報告します。  
　OWASP ZAPはOSSで提供される脆弱性診断を行う為のアプリケーションです。機能が概ねGUIで提供されていて容易に診断、結果のフィードバックが行えます。動的スキャンを用いたのでその流れを示します。  
 
　流れ: 
　　1. 以下の公式リポジトリの「wiki」タブからダウンロード -> OSに合わせて適宜インストールする  
　　　https://github.com/zaproxy/zaproxy  
  
　　2. OWASP ZAPを使用するためにFirefox等のブラウザでプロキシの設定を行う(以下は例)  
　　　proxy: 127.0.0.1 / port: 57777  
　　　＊これによりブラウザの通信を傍受可能になる(脆弱性診断に用いるため設定必須)
  
　　3. OWASP ZAPの証明書を生成し、ブラウザにインポートする
　　　＊基本ブラウザはFirefoxが推奨されている、プロキシや
  
　　4. OWASP ZAPを起動、ここからは参考文献(本:OWASP ZAPではじめるウェブアプリ脆弱性診断/脆弱性診断研究会)に沿って以下を設定した  
　　　モード, 診断範囲(コンテキスト, スコープ), スキャンポリシー  
  
　　5. コンテキスト内のターゲット上で動的スキャンを選択し、実行する -> アラートタブにスキャンの結果(検出した脆弱性や改善点等)が表示される  
  
　ざっくり言うとこんな流れになります。OWASP ZAPを使っていてすごいなと感じたのはこの動的スキャンの結果に「設定ミス」の類についてもフィードバックされた点ですね。自前で運営している某サイトの試験環境に動的スキャンを走らせた結果、「X-Content-Type-Optionsヘッダ」の設定がされておらず悪意のあるスクリプトがインジェクションされる危険性が潜んでいました(怖い...)。サイトの開発のなかでHTTPヘッダの設定を意識しないまま開発していたが故のミスです...。奥が深いなぁ...。  

<img src="https://raw.githubusercontent.com/SuperConsole/SpCn-Diary/master/src/img/OWASP-ZAP-result-alert.png" width="100%" style="max-width:381px;">  
  
　次は気が向いたら似たようなアプリであるBurp Suiteに触れた所感を書こうかなーと思っていたりいなかったりですね。おわり。  
  
　＊追記: HTTPヘッダの設定とセキュリティについていい感じのサイトを見つけたのでメモ  
　セキュリティを強化する7つの便利なHTTPヘッダ / https://devcentral.f5.com/s/articles/7http  
 
---
## Apache Struts 2におけるリモートコード実行[CVE-2018-11776]の脆弱性検証(07/02/19)
　某セキュリティ会社が発行している「JSOC INSIGHT」のvol.22にて「Apache Struts 2におけるリモートコード実行の脆弱性」が取り上げられていたので持ち前の情報収集力を生かしてこの脆弱性を再現・検証したのでそれをまとめます。
まず、この脆弱性はURLに数値計算式またはOSコマンドを実行するOGNL文をインジェクションすることで悪用されます。Apache Struts2の設定ファイルである「struts.xml」において、  
　 ・「alwaysSelectFullNamespace」をtrueにしている  
　 ・「actionタグ」または「urlタグ」が含まれている  
  
これらの条件をいずれも満たす場合に影響を受けます。今回の検証ではこの脆弱性を持つApache Struts 2.3.12内蔵のDockerコンテナ(piesecurity/apache-struts2-cve-2017-5638、以下Dockerコンテナ)を用意し、struts.xmlに設定を追加したのちにPoC(python)を実行し、サーバ内の機密情報(ここでは/etc/passwdファイル)を読み取るまでの流れを示す。  
  
　方法([hook-s3c氏のPoC](https://github.com/hook-s3c/CVE-2018-11776-Python-PoC)より):  
　 1. Dockerコンテナ(piesecurity/apache-struts2-cve-2017-5638)をdockerhubよりプル  
　  $docker pull piesecurity/apache-struts2-cve-2017-5638  
  
　 2. コンテナをポート32771番に指定しデタッチモードにて起動//被害側  
　  $docker run -d -p 32771:8080 piesecurity/apache-struts2-cve-2017-5638  
  
　 3.  エディタ(vim)をインストールした後設定ファイルを編集する(内容はリンク先参照,設定ファイルの様式にしたがって追加すること)  
　  $vim /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/struts.xml  
  
　 4. Apache Struts2(Dockerコンテナ)を再起動  
　  $exit  
　  $docker restart [コンテナID]  
　  $docker exec -it [コンテナID] bash  
  
　 5. 攻撃側PCからDockerコンテナの32771番ポートにアクセス　　

<img src="https://raw.githubusercontent.com/SuperConsole/SpCn-Diary/master/src/img/CVE-2018-11776-poc-struts2.png" width="100%" style="max-width:400px;">  
  
　 6. URLの指定部(JSOC INSIGHTを参照)にOGNL文を挿入する([atucom.net](http://blog.atucom.net/2018/08/apache-struts-2-vulnerability-exploit.html)よりOSコマンドからOGNL文生成するPoCが公開されているのでこれを利用した。ウイルスに感染する恐れがあるので実行は自己責任)  
　  $python ./a.py  
  
　 7. OSインジェクションが行われ、攻撃側にて被害側内にある機密情報/etc/passwdファイル)の読み取りに成功していることを確認できる。  

<img src="https://raw.githubusercontent.com/SuperConsole/SpCn-Diary/master/src/img/CVE-2018-11776-poc-result.png" width="100%" style="max-width:600px;">  
  
　以上。数値計算式を挿入するPoCはザッと調べただけでもかなりのサイトに載っていたが実際に悪用可能なOGNL文を挿入するコードを公開するJSOC INSIGHTは一味違うなと実感しました(誰目線)。話は変わるのですが、以前[PoCに見せかけて本当にリモートで実行されるやつ](https://web.archive.org/web/20190702145836/https:/twitter.com/x64koichi/status/1141635520419602432/photo/1)が巷で話題になりましたね。こういうことが少なからずあるのでPoCを使って検証するにはソースコードに目を通すことが大前提です。  
　今回の環境ではtruts.xmlの「alwaysSelectFullNamespace」を無効にしたことでONGL文によるOSインジェクションが効かなくなったこと、バージョンアップによって脆弱性が解消されたことを確認しました。セキュリティ、日頃から意識していきましょう...。おわり。


---
## VPNGate with Proxyを用いた通信の秘匿(06/15/19)
　先日にTorネットワークを用いてIPアドレスを隠蔽する方法を記事にしたが、今回は通信自体の隠蔽について。VPNGate with Proxyを用いることでVPNでの通信を可能にし、情報の盗聴を防ぐことができます。また、末端接続先(Webサイトなど)からはVPNサーバのIPアドレスしか見られない状態になります。  
 しかしVPNサーバが情報を開示した場合はIPアドレスが丸わかりになるので悪用厳禁。  
  
通信方法(Debian9):  
　1. VPNGate With Proxyに必要なアプリケーションをインストールする  
　　$apt install gir1.2-appindicator3-0.1 gir1.2-notify-0.7 python-gobject  
    
　2. VPNGate with Proxyをインストール(クローン→解凍)する(・・・部はGithubのドメイン)  
　　$git clone ・・・/Dragon2fly/vpngate-with-proxy  
　　(\*クローンしたディレクトリ配下にアプリケーションがある)   
  
　3. VPNGate with Proxyを起動する  
　　$./vpngate-with-proxy/run  
  
　4. 一覧から接続したいサーバを選択し、番号をコマンドラインに入力する  
 　　(サーバのindexが0の場合) >>0  
   
　5. コネクションの確立後、IPアドレスがサーバのものになっているか確認する  
　　$curl -sL ipinfo.io  
 
　以上。また、VPN Gateway with Proxyは筑波大学が提供するサービス「VPN Gate」の非公式Linuxクライアントである。利用する際は自己責任で。  
   
　この記事を書く上で本当は「VPN Over Tor」というTorを経由した後にVPN通信を行ってインターネットに接続する環境を構築したかったがTor経由でのVPN Gateway with Proxyのサーバへの接続がうまくいかずに断念した。原因は今も模索中であるがTorネットワークは一般的なプロキシとはやや違う仕組みで動いているのでいろいろ設定をする必要があると考えている。保証のきいたVPNサービスを利用するのが無難だが向きになっている自分がいるので一つ一つ自分のペースで対処していきます。次回はペネトレーションテストツールを使ってみたりしようかなと思っています。おわり。

---
## 防衛のためのTorネットワーク(06/14/19)
　Torとは、The Onion Routerの略でSOCKSプロキシを何重に経由することでIPアドレスの匿名性を向上させる技術を指します。もとは米軍により開発された技術ですが現在はTor Projectが管理運営をしています。IP匿名化の仕組みは説明すると長くなるので端的に言えば寄り道をしまくって経由するサーバごとにIPアドレスを書き換えるといった感じになりますね。また、SOCKSはTCPを包括するシステムなのでHTTP/HTTPSだけでなくTCP上で動作するプロトコルなら通信が可能です(もちろんUDPはできない)。  
  
通信方法:  
　1. Torをインストールする(aptコマンドなどで直接行う方法が簡単)  
　　ex: $sudo apt install tor  
　2. Torを実行する  
　　ex: $tor  
　3. Torの入り口となるプロキシを通すため、アドレスとポート番号を設定する  
　　\*具体的なアドレス、ポート番号は正規のモノを参照して適宜入力  
　4. IPアドレスが偽装できているか確認する  
　　ex: curl -sL ipinfo.io  
　　(\*IPアドレスの確認方法に関して指定はない)
  
　注意: TorはIPアドレスの匿名には貢献できるがセキュリティの信頼性を保証するものではないです。HTTPやIMAP, POPなどの通信化を行わないプロトコルでの通信は盗聴されるリスクがあります。また、中継サーバのにはトラフィックを解析したり捜査関係者のサーバが紛れ込んでいることがあるので最低限のリテラシーは必要です。  
  
　調べてみたらTor Over VPNという言葉があるらしく、Torネットワークにアクセスする前に一度VPNを通す方法で、Torネットワークの入り口ですら送信元IPを隠蔽し、匿名性を高める方法だそう。フリーだとOpenVPNなどがありますがNordVPNというところが提供している「Tor Over Vpn」といった保証付きのサービスを使うのも手段としてありですね。  
  
 <img src="https://i.imgur.com/XddQXJd.jpg" width="100%" style="max-width:900px;">
  
遅延が大変なことになりそうだけど...。  
あと、Torの話はしたもののダークウェブには興味ないです。本当に...。  
  
　あと、身元を完全に隠したいユーザには匿名OS「Tails」があり、これを使えば万が一Torの中継サーバが裏切って生身のIPが特定されても直接の被害はなくなります。以上Torに関する記事(殴り書き)でした。おわり。

---
## ハッシュによるファイルの正当性検証(06/08/19)
　何気なくインターネットからファイルをダウンロードしてファイルの正当性を疑うこともなくそのままインストールして...
でもセキュリティリテラシーの観点からするとよろしくないのでハッシュによる検証を癖つけるために記事にしました。  
方法(kali-linux-2019.2-amd64.isoの例):  

　1. 公式サイトから検証対象の.isoファイル(kali-linux-2019.2-amd64.iso)をダウンロードする  

　2. OpenSSLを使ってハッシュ(今回はサイトのアルゴリズムにしたがってsha256)を以下のコマンドで算出(パイプで渡すのは個人的な好み)  
　　$cat ./kali-linux-2019.2-amd64.iso | openssl sha256  

　3. 出力されたハッシュ値とサイト上にあるSHA256Sumの値が一致しているか確かめる  
　　>67574ee0039eaf4043a237e7c4b0...(例におけるハッシュ値)

　4. 同じであれば正当性が確立, 異なればハッシュのアルゴリズムが同じか見直すか再ダウンロードを行う

　簡単にできますね。しかし正当性の検証は大事なことです。なので忘れずにパソコンライフを送りたいと思います。  

余談:  
　ちなみに今日はデジタル署名とか認証まわりも学習していて、ネットサーフィンしてたら本物の"オレオレ証明書"のサイトを見つけました。でもChromeがちゃんと警告出してくれたのですぐに気づきました。詳細で確認するとルート証明書があからさまに怪しいドメインで面白かったです。以上。おわり。


---
## JavaによるIteratorパターンの実装(04/11/19)
　Iteratorパターンとは  
 
　1.　数え上げたいオブジェクト(以下、具象クラスBookShelfを例として挙げる)をAggregate(集合体)インターフェースとして実装。Aggregate内で実際に数え上げるIteratorを宣言。すなわち、Aggregateの実装であるBookShelf内にIteratorの実装であるBookShelfIteratorを宣言する。BookShelf内の各Book(数え上げられるもの, 単体)は、BookShelfの持つインターフェース(getLength:本の許容数, getBookAt:本のインデックス)によってBookShelfIteratorからアクセス可能であり、数え上げを実行する際にBookShelfインスタンスを宣言し、その中のIterator生成関数を実行し、繰り返し処理を行えば良い。  
 
　2.　Aggregate(Iteratorを内部に宣言)->Iterator(hasNextとnextを保持) //抽象クラス  
　    BookShelf(Iteratorを内部に宣言)->BookShelfIterator(hasNextとnextを保持) //具象クラス

　本当にメモをベタ貼りしただけです。数え上げを行う際に数える対象が配列かVectorか他の型に従った集合かによって繰り返し処理の内容が異なってしまう問題を解決するデザインパターンです。これにより、例えば、開発当初は配列で宣言していた集合を可変にしたいと案が出てVectorにした場合でも簡単に改修ができ工数を削減できるメリットがあります。  
 
　便利ですね！実装を~~Python~~Javaで書いて別のリポジトリにあげようかなと考えています。実装します。おわり。

※追記(04/12/19)Pythonってインターフェースの実装向いていないことを実感したのでちゃんとJavaで実装します。

---
## Metasploit+docker(+nmap)で試すHeartbleed(04/10/19)
　Heartbleedというメモリリークから個人・機密情報を漏洩させる脆弱性。頑張ればこの脆弱性を持ったサーバーをイントラネットに立てて擬似攻撃できるんじゃね？って思ったのでやってみました。サーバーを立てるのにdockerを使い、コンテナイメージは[hmlio/vaas-cve-2014-0160
](https://hub.docker.com/r/hmlio/vaas-cve-2014-0160/)を使用します(VaaSなんて言葉があるのな...)。以下に手順記載しますー  

1.dockerで[hmlio/vaas-cve-2014-0160
](https://hub.docker.com/r/hmlio/vaas-cve-2014-0160/)をプル  

2.ポート(usageに書いてあったので8443にした)を指定して起動(dockerhub内の手順に従った。このコンテナが被害者側)  

(2'.nmapのHeartbleed検知スクリプトを使って被害者側が脆弱性を持つか確認)  

3.攻撃者側(Kali Linux)でMetasploitを起動  

4.CVE番号で検索をかけてHeartbleedモジュールを使用  

5.オプションをいくつか設定して実行(RHOST, RPORT, VERBOSEの三つを設定した)  

6.被害者側のメモリがリークしたのを確認できた。  

ちなみに、HeartbleedはOpenSSLで暗号化通信をしていても通信の末端では復号してメモリに展開されているという隙をついた脆弱性です。もともとは接続確認とか応答の意味を兼ねてパケットをとんぼ返りするHeartbeatパケットというのがあり、その中のLengthというパケットの大きさを返すパラメータに実際の大きさを超える値をセットし、偽装した大きさと実際の大きさの差分だけメモリがリークする仕組みだ。JVNのデータを見るとOpenSSLはv1.0.1~v1.0.1fまでとのこと。執筆時点での最新版がv3.0.0なのでアップデートしていれば心配することはない。ただ、2014年に見つかったこの脆弱性は2016年ごろまで被害が起きていたことからユーザのインシデント対応の遅さが問題に繋がる原因ともなるので注意が必要です。

うーん、それにしてもただただマニュアル読んでその通りにしただけでは？スクリプトキディみたい...。でもそれだけツールが充実しているということですね。手順がかなり端折っているのは詳しく書きすぎるとクラッキングの助長になってしまうかなと思ったからです。たぶんこの記事を読んだだけでクラッキングができたら元から知ってたよね？くらいの抽象度合いなので大目にみてくださいー。あ、このコンテナでOpenSSLをアップデートして脆弱性が解消されてるか確認しようとしたけどアップデートができなかった...脆弱性確認用だから対策されてるのかな...?おわり。

参考:  
　[JVNDB-2014-001920
](https://jvndb.jvn.jp/ja/contents/2014/JVNDB-2014-001920.html)  
　[え？今さらHeartBleedの話ですか？](https://www.lac.co.jp/lacwatch/people/20161013_001056.html)
 
---
## 本『ぐでたまの資本論』 (04/09/19)
　「お金と上手につきあう人生哲学」。そのフレーズに一目ぼれして衝動買いしてしまいました。内容はマルクスの資本論をわかりやすくかみ砕いた解説とぐでたまのかわいらしいイラストを各ページごとに区切って載せている形です。下部に元となる資本論の原文が参考として記載されているところが個人的にポイント高かったです。フレーズからお金を主軸に展開していくのかなと予想していたのですが、仕事のありかたやワークライフバランス、本能的な欲求に触れていたり読みごたえがしっかりしている本でした。まだ読み終えてはいないんですけど空き時間にちょこっと摘まめるような、そんな感じの本でもあるのでいい買い物ができたなという所感です。おわり。

---
## 粗挽きから抽出したコーヒーを飲んだ(04/08/19)
　粗挽きした豆から抽出したコーヒーを初めて飲んだ。香りとか深みとかは細挽きより劣るがその分飲みやすいです。しかし、普段の細挽きでの抽出方法と全く同じ方法で抽出したので風味がコーヒーというよりは紅茶に近いような感じになってしまいました。深い味わいとコク, 余韻を求めている身としては物足りないような気がしました。粗挽きの抽出方法でオススメはないかと調べたらペーパードリップではなくフレンチプレスやパーコレーターを使うのがベストらしいです。ところで違いが気になったので調べました。  
 
「ペーパードリップと比べた際のフレンチプレスの特徴」  
 雑味が出やすい / 豆本来の味が楽しめる / 粉っぽさが残る / 複雑な風味が生まれる / 表面に油が浮かぶ / 欧米向き / etc...  

　日本人の"ダシ文化"(おいしいとこだけ抽出する)が根付いていることからペーパードリップの方が好まれる傾向らしいです。ただ興味があるのでフレンチプレスをするための用具を用意して違いを楽しみたいなーって思います。おわり。

---
## 知識と経験(04/03/19)
　4/01からセキュリティオンライン講座でケーススタディを通して勉強をしています。去年に情報処理安全確保支援士試験合格(以下、SC)をした自分ですが、実際にデモなどを通じて感染経路や対策を知るというのはとても大事だなと感じます。  

　SCで得られるのはセキュリティ分野における専門用語の意味, 実際のネットワークへのウイルスの対策経路/防止など体系的な知識であり、即戦力はないですが、経験を積みそれを今後に生かしていくための土台であると考えていて、実際SCで得た知識がこの講座の内容をスムーズに理解するのにつながっていると感じる場面が多くあります。  
 
　たくさんの講座が用意されていてとてもワクワクしています！たくさん学んで経験につなげていくぞ！おわり。

---
## 本『デザイン思考の先を行くもの』(03/22/19)
　この本を読むきっかけはデザインという今まで漠然として受け取っていた概念に対して正面から向き合いたいと思っていたところにふとこの本が目に留まったことです。  
内容はデザインがどのようなものであり、何を実現・解決するのかを述べて実例や応用例を示しながら将来のあり方を問うといったものでした。読み終わるとデザインとアートの違いがわかるようになり、またこの二つのフィルターを交互に使い変えながら違ったオブジェクトの見方をすることができるようになりメタ思考のひとつを得たのかなと思います。  

　特に新しいアイデア=既存のアイデアの**新たな組み合わせ**という考え方や**ウォーリーを探せ法**, **因数分解**といったフレームワークもいくつか載っていて実際に活用する上で即戦力になるような情報も得られました、非常に興味深い本でした。おわり。  

### Keywords / Summary
デザイン≠アート / デザインの根本は問題解決 / バックキャスティング思考 / 未来 ≠ こうあるべき->未来 = こうしたい / スペキュラティブデザイン: 未来はこうもありえるのではないか / 専門性ではなく「ビジョン」で組織を分ける / アイデア = 革新したいこと + 異分野領域の専門知識 / ウォーリーを探せ法: 情報をインプットする前にミッションを与える -> 特定の「見立て」をサポート (ex. レシピ本から建築 / 関連性の低いもの同士に関連性を強制的に見つけ出すプロセスの中で発想が生まれることがある / 世界の広さは言葉の量で決まる / 「1」はゴールではない / 社会の潮流を加味する / スモールスタート (ex. 電通Bチーム, mercari R4D /

---
## セキュリティオンライン講座を申し込んだ(03/20/19)
　先ほど、メールにてオンラインで受講可能なセキュリティの講座の申し込みを済ませてきた。最近作曲を中心とした生活を送っていたので全くコードも書いてないししばらくエンジニア面の勉強から離れていた(CpawCTFは全クリしたけど結局writeupを写す作業が多くなってしまったな...)。  
  
　もし申し込みが通れば(抽選制らしいので)4月から受講可能になる。主にインシデントレスポンスと安全設計など即戦力になりそうな内容を受講する予定。  
まぁ、実は申し込んだ所内定先のとこなんですけどね...。他の内定者より一歩先に進んで差を付けるぞ！！！的な意気込みも多少ありつつそれが後押しとなって
申し込むに至りました(その中で自分がはたらきたい業務分野を見つけてからのア○○○○ド採用を...)。  

頑張るぞー！！！！！おわり。

---
## "続けること"について(02/28/19)
　久しぶりの更新になってしまいました。もはや日記というか気が向いたら書こうかな的な落書きノートみたくなっていますね。  
日記を書く理由として以前に「Githubに毎日コミットして更新することを習慣づけるため」と謳っていましたがそもそもGithubに執着し続ける意味が見いだせない？と見切った結果なのでしょうか...。常に勉強をし続けて日々探求していくという根本的な考えというか姿勢は完全に放棄したわけではありません。たぶん。  

　前回の日記から今回に至るまでに「神・時間術」という本をはじめとしていくつか自己啓発本を購入して読んできたのですが、その中で人生にはプログラミングやWebデザイン, アイデア発案といった概念と同様、それの利便性, 効率を向上させる「フレームワーク」が存在していて人生も同じように"適用させる"ことが可能だという考えを感じていました。フレームワークがあるからにはそれを学習するコストと日々経験を積んで使いこなしていくことが必要なように、自己啓発本で得た知見やら考える姿勢も自身の生活に適用させて使いこなすことが必要です。  
 
　自己啓発本をいくつか通してふと日記を書こうと思いついたのですが、やはり日記を書かなければいけないという義務感に襲われていたのかサボり始めてから存在が頭の中から消えていました...。"続けること"...、それは続かせるとかではなくて"目的のために続けることが前提である"みたいな先行条件を見出して無理なく進めることが必要だったんだと知りました。  
 
 日記はこの先行条件が整ってから自分のペースで気が向いたら更新するてきな感じにします。おわり。

---
## CTFを始めるのでまずはDockerで環境を構築する(01/31/19)
内定先でCTF(Capture The Flag)をしている人が多いとインターンや説明会で聞いていて前から興味を持っていたのですが、最近プログラムやIT技術とか触れてないなーって感じていたので今日から始めようと思ったわけです。  
まずは環境の構築ですね。普段持ち歩くノパソのホストOSがWidows10proなのでHyper-V上にDockerを突っ込んでそこにKaliLinuxを積みます。  
KaliLinux上でいろいろ遊んだりするんですねー楽しみです。現段階ではまだインストール終わってないので早く終わってくれい！おわり。

---
